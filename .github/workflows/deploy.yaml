name: Deployment
on:
    push:
        branches:
            - master

env:
    CLEVER_URL: ${{ secrets.CLEVER_URL }}
    CLEVER_TOKEN: ${{ secrets.CLEVER_TOKEN }}
    CLEVER_SECRET: ${{ secrets.CLEVER_SECRET }}
    CLEVER_DIR: ${{ secrets.CLEVER_DIR }}
    GH_SHA: ${{ github.GITHUB_SHA }}

jobs:
    deployment:
        runs-on: ubuntu-latest
        environment:
            name: test
            url: ${{ env.CLEVER_URL }}
        steps:
            -   uses: actions/checkout@v2
            -   name: Install clever-tools
                run: npm install -g clever-tools
            -   name: Deploy
                run: |
                    mkdir -p ~/deployment
                    rm -rf .git
                    cp .clever.json ~/deployment/
                    cp -r clevercloud  ~/deployment/
                    cd $CLEVER_DIR && tar cvzf ~/deployment/artifact.tgz ./
                    cd ~/deployment
                    git config --global user.email "madamebiz@monsieurbiz.com"
                    git config --global user.name "Madame Biz"
                    git init
                    git add -A
                    git commit -m "Deploy $GH_SHA"
                    clever login --token $CLEVER_TOKEN --secret $CLEVER_SECRET
                    clever deploy --force
                    
